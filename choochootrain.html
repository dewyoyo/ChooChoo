<!DOCTYPE html>
<html lang="en-us">

<head>

    <meta charset="UTF-8">
    <title>Train schedule</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        .jumbotron{
            color : white;
            background-color : brown;
            text-align: center;
        }
        .card-header {
            color : white;
            background-color : blue;
        }
        #train-head-row {
            /* color : white; */
            font-weight: bold;
        }
        #train-current-row:nth-child(even) {
            background-color: lightgray;
        }
        #update-train, #remove-train {
            margin : 10px;
            padding : 5px;
            font-size : 9pt;
            background-color: darkgray;
            color: white;
        }
    </style>

</head>

<body>

    <div class="container">

        <br>

        <!-- Jumbotron -->
        <div class="jumbotron">
            <h1 class="text-center">Anytime is Train Time</h1>
            <p>Choo Choo. Chee Chee.</p>
        </div>

        <div class="row">

            <!-- Current Train schedule -->
            <div class="col-lg-12">
                <div class="card card-default">
                    <div class="card-header">
                        Current Train schedule
                    </div>
                    <div class="card-body" id="current-schedule">
                        <div class="row" id="train-head-row">
                            <div class="col-md-2">Train name

                            </div>
                            <div class="col-md-2">Destination

                            </div>
                            <div class="col-md-2">Frequency(min)

                            </div>
                            <div class="col-md-2">Next Arrival

                            </div>
                            <div class="col-md-2">Minutes Away
                            </div>
                            <div class="col-md-2">
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>


        <br>
        <!-- Sign-Up Card-->
        <div class="row">
            <div class="col-lg-12">
                <div class="card card-default">
                    <div class="card-header">
                        Add Train
                    </div>
                    <div class="card-body" id="form-add-train">

                        <!-- Sign-up Form (note the various input "types")-->
                        <form role="form">
                            <div class="form-group row">
                                <label for="train-input">Train Name:</label>
                                <input class="form-control" id="train-input" type="text">
                            </div>
                            <div class="form-group row">
                                <label for="desti-input">Destination</label>
                                <input class="form-control" id="desti-input" type="text">
                            </div>
                            <div class="form-group row">
                                <label for="time-input">First Train Time (HH:mm - military time)</label>
                                <input class="form-control" id="time-input" type="time" pattern="([0-1]{1}[0-9]{1}|20|21|22|23):[0-5]{1}[0-9]{1}">
                            </div>
                            <div class="form-group row">
                                <label for="frequency-input">Frequency(min)</label>
                                <input class="form-control" id="frequency-input" type="text">
                            </div>
                            <button class="btn btn-default" id="add-train" type="submit">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.9/firebase.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/locale/af.js"></script> -->
    <!-- Link to Moment.js should go here -->
    <script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>

    <!-- JavaScript -->
    <script>

        var config = {
            apiKey: "AIzaSyDoBddgL_yJQw6odhEVxGBAA0zD_B4mjso",
            authDomain: "choochootrain-26a7d.firebaseapp.com",
            databaseURL: "https://choochootrain-26a7d.firebaseio.com",
            projectId: "choochootrain-26a7d",
            storageBucket: "choochootrain-26a7d.appspot.com",
            messagingSenderId: "942572432155"
        };
        firebase.initializeApp(config);

        // Get a reference to the database service
        var database = firebase.database();

        database.ref().on("value", function (snapshot) {


        });

        function addTrainClear() {
            $("#train-input").val("");
            $("#desti-input").val("");
            $("#time-input").val("");
            $("#frequency-input").val("");
        };

        // Capture Button Click
        $("#add-train").on("click", function (event) {
            // prevent page from refreshing when form tries to submit itself
            event.preventDefault();

            var trainInput = $("#train-input").val().trim();
            var destiInput = $("#desti-input").val().trim();
            var timeInput = $("#time-input").val().trim();
            var freqInput = $("#frequency-input").val().trim();

            // database.ref("/employeeList").push({
            database.ref().push({

                trainID: trainInput,
                destination: destiInput,
                startTime: timeInput,
                frequency: freqInput

            });

            addTrainClear();

        });
        //database data added
        database.ref().on("child_added", function (snapshot) {
            console.log(snapshot.val());
            console.log(snapshot.key);
            var dataKey = snapshot.key;

            //time calculation for next train
            var nextT = snapshot.val().startTime;
            console.log(snapshot.val().startTime);
            var nowT = moment().format("HH:mm");
            var intervalT = snapshot.val().frequency;

            if (nextT < nowT) {
                console.log("nextT: " + nextT);
                console.log("nowT: " + nowT);
                //moment(randomMoment).add(10, "minutes")
                while (nextT <= nowT) {
                    nextT = moment(nextT, "HH:mm").add(intervalT, "minutes").format("HH:mm");
                    // console.log("add nextT: " + nextT);
                }

            }
            else {
                console.log("eeeenextT: " + nextT);
                console.log("eeee nowT: " + nowT);
            };

            var minAway = moment(nextT, "HH:mm").diff(moment(nowT, "HH:mm"), "minutes");

            var newRow = "<div class='row' id='train-current-row'>" +
                "<div class='col-md-2'> " + snapshot.val().trainID + "</div>" +
                "<div class='col-md-2'> " + snapshot.val().destination + " </div>" +
                "<div class='col-md-2' contenteditable='true'> " + snapshot.val().frequency + " </div>" +
                "<div class='col-md-2'> " + nextT + " </div>" +
                "<div class='col-md-2'> " + minAway + " </div>" +
                "<button class='btn btn-default' id='update-train' type='submit' data-train-key=" + dataKey + ">update</button>" +
                "<button class='btn btn-default' id='remove-train' type='submit' data-train-key=" + dataKey + ">remove</button>";

            $("#current-schedule").append(newRow);

            // Handle the errors
        }, function (errorObject) {
            console.log("Errors handled: " + errorObject.code);
        });

        // update button click
        $("div.row").on("click", "#update-train", function (event) {
            // prevent page from refreshing when form tries to submit itself
            event.preventDefault();

            var updateTrain = $(this).attr("data-train");
            console.log("update-train button clicked: " + updateTrain);



        });

        // remove button click
        $("div.row").on("click", "#remove-train", function (event) {
            // prevent page from refreshing when form tries to submit itself
            event.preventDefault();
            var removeTrain = $(this).attr("data-train-key");
            console.log("remove-train button clicked: " + removeTrain);

            database.ref().child(removeTrain).update({
                trainID: null,
                destination: null,
                startTime: null,
                frequency: null
            });

        });

    </script>

</body>

</html>